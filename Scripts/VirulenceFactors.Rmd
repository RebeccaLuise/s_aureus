---
title: "S.aureus virulence factors"
author: "Rebecca L. Knoll"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## plan
Here we want to explore Virulenzfaktoren, presence/absence, PCA - Jaccard-Distance und PERMANOVA - zwischen den Studien, Anzahl, Diversität, zwischen den Studien und den Ländern
```{r}
library(tidyverse)
```


## load data 
```{r}
v1 <- read.delim("/Users/rebecca/Documents/Forschung/preterm_metaG_analysis/data/vfdb/VFDB.StaphAureus.considered.tsv")

v2 <- read.delim("/Users/rebecca/Documents/Forschung/preterm_metaG_analysis/data/vfdb/VFDB.StaphAureus.matrix.tsv") # has 239 samples

v3 <- read.delim("/Users/rebecca/Documents/Forschung/preterm_metaG_analysis/data/vfdb/VFDB.StaphAureus.SPIRE.considered.tsv")

v4 <- read.delim("/Users/rebecca/Documents/Forschung/preterm_metaG_analysis/data/vfdb/VFDB.StaphAureus.SPIRE.matrix.tsv") # has 214 samples

summary(as_factor(v1$Cohort))
summary(as_factor(v3$Cohort))
```
# add correct sample names for metaG Run Feb'25
```{r}
library(readxl)
xl_1 <- read_excel("/Users/rebecca/Documents/Forschung/PRIMAL/metaG_seq_2025/Liste für Novogene_14.02.2025.xlsx")
xl_2 <- read_excel("/Users/rebecca/Documents/Forschung/PRIMAL/metaG_seq_2025/04.03.2025 qc plus 4  NC plus 10 duplikates.xlsx")
xl_1 <- clean_names(xl_1)

xl_2 <- xl_2 %>% 
  mutate(no_novogene = as.numeric(gsub("A0*", "", `Sample Name`))) # removes 'A' and leading 0s

xl_1 <- xl_1 %>% 
  full_join(xl_2, by="no_novogene") %>% 
  mutate(mainz_id_x= case_when(is.na(mainz_id_x)~`Nucleic Acid ID`, T~mainz_id_x))

xl_1 <- xl_1%>% 
  filter(!is.na(mainz_id_x))

primal_md <-  read.csv("~/Documents/Forschung/preterm_metaG_analysis/data/Metadata/PRIMAL_master_metadata_20250402.csv")

md_n3 <- primal_md %>% 
  select(primalID, mainzID.x) %>% 
  filter(!is.na(primalID))

n3_names <- xl_1 %>% 
  left_join(md_n3, by=c("mainz_id_x"="mainzID.x")) %>% 
  mutate(sample_name= paste("A", no_novogene, sep = "")) %>% 
  mutate(cat_sample_name= paste0("X",primalID,".N3")) %>% 
  select(sample_name, cat_sample_name, mainz_id_x)

n3 <- v1 %>% 
  filter(Cohort=="PRIMAL3") 

n3_samples <- n3 %>% 
  left_join(n3_names, by=c("mainzID"="mainz_id_x"))

write_csv2(n3_samples, "/Users/rebecca/Documents/Forschung/PRIMAL/metaG_seq_2025/correct_PRIMAL3_names.csv")

```

# rename PRIMAL samples to the sample names used in the S.aureus prevalence testing
```{r, eval=FALSE}
ps_all_clean <- readRDS("/Users/rebecca/Documents/Forschung/PretermMicrobiomeCatalogue/mOTU_preterm_catalogue_09152025.rds")

meta_all_df_clean <- as(sample_data(ps_all_clean), "data.frame")

meta_all_df_clean %>% 
  filter(study_id=="PRIMAL")
```


```{r}
# first merge into one single data set

vfdb <- v2 %>% left_join(v4, by= c("Category", "VF_short", "VF_long","GENE")) # 

md <- v1 %>% 
  rename(Sample = ID) %>% 
  select(Cohort, Sample) %>% 
  rbind(v3)

md %>% 
  count(Cohort)
```
# select the samples that were also considered for the S.aureus prevalence and abundance testing
```{r}
ps_all_clean <- readRDS("/Users/rebecca/Documents/Forschung/PretermMicrobiomeCatalogue/mOTU_preterm_catalogue_09152025.rds")

meta_all_df_clean <- as(sample_data(ps_all_clean), "data.frame")

# lets now filter the vfdb to the cohorts that have been used in the S.aureus detection:
md_fil <- md %>% 
 filter(Cohort%in% c(meta_all_df_clean$study_id, "PRIMAL1", "PRIMAL2", "PRIMAL3", "Replicates"))

meta_all_df_clean <- meta_all_df_clean %>% 
  rownames_to_column("Sample")

md_fil_primal <- md_fil %>% 
  mutate(cohort = if_else(str_detect(Sample, "PRIMAL|Replicates"), "PRIMAL", "US")) %>% 
  filter(cohort == "PRIMAL")

primal_samples <- md_fil_primal %>%
   separate(Sample, into = c("mainzID", "Cohort"), sep = "\\.\\.\\.", remove = F) %>% 
 left_join(primal_md, by = c(c("mainzID"="mainzID.x"), "Cohort"))

PRIMAL_cat <- meta_all_df_clean %>% 
  filter(study_id=="PRIMAL")

primal3 <- PRIMAL_cat %>% 
  left_join(primal_samples, by= c("sample_id" ="Study_id")) %>% 
  filter(is.na(primal_id_center)) %>% 
  left_join(n3_samples, by=c("Sample"="cat_sample_name")) %>% 
  select(Sample, ID, primal_id_center) %>% 
  separate(ID, into = c("mainzID", "Cohort"), sep = "\\.\\.\\.", remove = F) %>% 
  mutate(primal_id_center=gsub("X", "", Sample))

# This pastes the study ID for PRIMAL 1, PRIMAL 2 and Replicates
primal1_2 <- PRIMAL_cat %>%
  left_join(primal_samples %>% select(-Cohort), by= c("sample_id" ="Study_id")) %>% 
  select(mainzID, Cohort, primal_id_center, Sample) %>% 
  filter(!is.na(mainzID))%>% 
  left_join(v1, by=c("mainzID","Cohort")) %>% 
  select(mainzID, Cohort, primal_id_center, ID, Sample )

final_primal_ids <- rbind(primal1_2, primal3) 

final_primal_ids_fil <- final_primal_ids %>% 
  filter(Sample%in%c(PRIMAL_cat$Sample)) %>% 
  distinct(Sample, .keep_all = T)

# add these to the catalogue metadata
md_cat_new <- meta_all_df_clean %>% 
  left_join(final_primal_ids_fil, by= "Sample") %>% 
  mutate(ID = case_when(is.na(ID)~Sample, T~ID))

# retain only the samples that were also tested for S.aureus prevalence
v1_fil <- v1 %>% 
  filter(ID %in% final_primal_ids_fil$ID)

v3_fil <- v3 %>% 
  filter(Sample %in% meta_all_df_clean$Sample)

matched_samples <- c(v1_fil$ID, v3_fil$Sample)

```

# I want to increase presence/absence matrix with the samples that didn’t hit any virulence gene 
→ those samples should appear as all zeros across every gene.
```{r}
normalize_samples <- function(samples) {
  samples %>%
    # Replace "-<digit(s)>..." before cohort with ".<digit(s)>..."
    str_replace("-(\\d+)(\\.\\.\\..+)$", ".\\1\\2")
}

# Get current sample names in matrix
present_samples <- colnames(vfdb[5:449])

# ---- Apply normalization ----
matched_norm <- normalize_samples(matched_samples)
present_norm <- normalize_samples(present_samples)

# ---- Compare ----
common <- intersect(matched_norm, present_norm) # 363 are shared
only_in_matched <- setdiff(matched_norm, present_norm) # 1411 samples are only in matched
only_in_present <- setdiff(present_norm, matched_norm) # 82 samples where not considered in the S.aureus analysis and should be removed

# 1. Keep only samples that are in matched_samples
vfdb_mat_filtered <- vfdb[, intersect(present_norm, matched_norm), drop = FALSE]

# 2. Find samples missing in vfdb_mat but present in matched_samples
missing_samples <- setdiff(matched_norm, colnames(vfdb_mat_filtered))

# 3. Create zero-filled matrix for missing samples
zero_mat <- matrix(
  0,
  nrow = nrow(vfdb_mat_filtered),
  ncol = length(missing_samples),
  dimnames = list(rownames(vfdb), missing_samples)
)

vfdb_mat <- cbind(vfdb_mat_filtered, zero_mat)
vfdb_mat[vfdb_mat > 1] <- 1 # this truly sets all genes to presence/absence = 1 vs 1

# Bind missing samples to existing matrix
vfdb_full <- cbind(vfdb[,1:4], vfdb_mat) # add gene names again

```



# first visu
```{r}
mat <- vfdb_full %>% 
  select(GENE, 4:1778)

# Step 1: Sum across samples
gene_counts <- mat %>%
  rowwise() %>%
  mutate(count = sum(c_across(-GENE))) %>%
  ungroup() %>%
  select(GENE, count)

# Step 2: Plot barplot
ggplot(gene_counts, aes(x = reorder(GENE, count), y = count)) +
  geom_col(fill = "steelblue") +
  coord_flip() +  # flips axes so genes are on y-axis
  labs(x = "Gene", y = "Number of samples with gene present",
       title = "Virulence gene presence across samples") +
  theme_minimal()
```


```{r}
# 1. Reshape into long format
df_long <- mat %>%
  pivot_longer(-GENE, names_to = "Sample", values_to = "Presence")

df_long <- df_long %>% 
  left_join(md, by="Sample") 

# 2. Define cohorts
df_long <- df_long %>%
  mutate(Cohort = if_else(str_detect(Sample, "PRIMAL|Replicates"), "PRIMAL", Cohort)) %>% 
  mutate(Cohort_2 = if_else(str_detect(Sample, "PRIMAL|Replicates"), "PRIMAL", "US"))

df_long %>% 
  count(Cohort)

df_long %>% 
  filter(Cohort=="PRIMAL") %>% 
  distinct(Sample)

# 3. Count number of samples per gene & cohort
gene_counts <- df_long %>%
  filter(Presence == 1) %>%
  group_by(GENE, Cohort) %>%
  summarise(count = n(), .groups = "drop")

# 4. Plot grouped barplot
ggplot(gene_counts, aes(x = reorder(GENE, -count), y = count, fill = Cohort)) +
  geom_col(position = "dodge") +
  coord_flip() +
  labs(x = "Gene", y = "Number of samples with gene present",
       title = "Virulence genes by cohort") +
  theme_minimal()
```


```{r, fig.height=5, fig.width=16}
# 3. Calculate prevalence per gene per cohort
gene_prevalence <- df_long %>%
  group_by(Cohort) %>%
  mutate(n_samples = n_distinct(Sample)) %>%   # total samples in each cohort
  group_by(GENE, Cohort, n_samples) %>%
  summarise(count = sum(Presence), .groups = "drop") %>%
  mutate(prevalence = count / n_samples)       # fraction of samples with gene

ggplot(gene_prevalence, aes(x = reorder(GENE, -prevalence), y = prevalence, fill = Cohort)) +
  geom_col(position = "dodge") +
  #coord_flip() +
  scale_y_continuous(labels = scales::percent_format()) +
  labs(x = "Gene", y = "Prevalence (fraction of samples with gene)",
       title = "Virulence gene prevalence by cohort") +
  theme_minimal()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "bottom")

ggsave("gene_prevalence_perCohort.pdf", width = 16, height = 5)
```
```{r}

md_cat_new$ID <- normalize_samples(md_cat_new$ID)

df_long_md <- df_long %>% left_join(md_cat_new %>% select(ID, delivery, age_years, age_days, timepoint_category, timepoint_category_2), by=c("Sample"="ID"))

gene_prevalence_dol <- df_long_md %>%
  group_by(Cohort, timepoint_category) %>%
  mutate(n_samples = n_distinct(Sample)) %>%           # total samples per cohort & timepoint
  ungroup() %>%
  group_by(GENE, Cohort, timepoint_category, n_samples) %>%
  summarise(count = sum(Presence), .groups = "drop") %>%
  mutate(prevalence = count / n_samples)

ggplot(gene_prevalence_dol, aes(x = reorder(GENE, -prevalence), y = prevalence, fill = Cohort)) +
  geom_col(position = "dodge") +
  #coord_flip() +
  scale_y_continuous(labels = scales::percent_format()) +
  labs(x = "Gene", y = "Prevalence (fraction of samples with gene)",
       title = "Virulence gene prevalence by cohort") +
  theme_minimal()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "bottom")+
  facet_wrap(~timepoint_category)

gene_prevalence_dol %>% 
  filter(timepoint_category=="DOL 43-455")

gene_prevalence_dol %>% 
  filter(timepoint_category=="DOL 9-42")

```
```{r}
library(vegan)   # for vegdist
library(ape)     # for pcoa
library(ggplot2) # for plotting

# --- Step 1: Calculate Jaccard distances ---

### ok for the moment I set NAs to 0

vfdb_mat[is.na(vfdb_mat)] <- 0

vfdb_mat_clean <- vfdb_mat[ rowSums(vfdb_mat, na.rm = TRUE) > 0, ]#Remove all-zero genes (rows)

#Strategies to include zero samples: Add a tiny “pseudo-count” for binary data

#For presence/absence, this means temporarily treating zeros as a very small presence for distance calculation:
vfdb_mat_adj <- vfdb_mat_clean
vfdb_mat_adj[vfdb_mat_adj == 0] <- 0  # still 0
# Add a tiny 1 to all-zero samples only for distance calculation
zero_samples <- which(colSums(vfdb_mat_adj) == 0)
vfdb_mat_adj[, zero_samples] <- 1e-6


# Make sure vfdb_matrix is a dataframe/matrix with samples in rows and genes in columns
vfdb_dist <- vegdist(t(vfdb_mat_adj), method = "bray")

view(vfdb_dist)

# --- Step 2: Run PCoA ---
pcoa_res <- pcoa(vfdb_dist)

# --- Step 3: Extract first two axes for plotting ---
pcoa_df <- as.data.frame(pcoa_res$vectors[, 1:2])
pcoa_df$Sample <- rownames(pcoa_df)

# If you have metadata with Cohort / timepoint, join it
pcoa_df <- pcoa_df %>% 
  left_join(md_cat_new, by = c("Sample"= "ID"))

# --- Step 4: Plot ---
ggplot(pcoa_df, aes(x = Axis.1, y = Axis.2, color = study_id, shape = timepoint_category)) +
  geom_jitter(size = 3, alpha = 0.8) +
  labs(x = paste0("PCoA1 (", round(pcoa_res$values$Relative_eig[1] * 100, 1), "%)"),
       y = paste0("PCoA2 (", round(pcoa_res$values$Relative_eig[2] * 100, 1), "%)"),
       title = "PCoA on VFDB presence/absence (bray (+ Pseudo count for 0))") +
  theme_minimal()

```
# Run PERMANOVA on samples that have virulence genes only (excluding 0 samples)
```{r, fig.height=4, fig.width=8}
library(vegan)
library(ape)
library(ggplot2)

# 1. Transpose so samples are rows
vfdb_mat_clean <- vfdb_mat[ rowSums(vfdb_mat, na.rm = TRUE) > 0, ]#Remove all-zero genes (rows)
vfdb_mat_t <- t(vfdb_mat_clean)

# 2. Keep only samples with at least one gene
nonzero_samples <- rowSums(vfdb_mat_t) > 0
vfdb_mat_nonzero <- vfdb_mat_t[nonzero_samples, ]

# 3. Compute Jaccard distance
vfdb_dist <- vegdist(vfdb_mat_nonzero, method = "jaccard", binary = TRUE)

# 4. Run PCoA
pcoa_res <- pcoa(vfdb_dist)

# 5. Prepare plotting dataframe
pcoa_df <- as.data.frame(pcoa_res$vectors[, 1:2])
pcoa_df$Sample <- rownames(pcoa_df)

# add metadata
pcoa_df <- pcoa_df %>% 
  left_join(md_cat_new, by = c("Sample"= "ID"))

# 6. Plot
ggplot(pcoa_df, aes(x = Axis.1, y = Axis.2, color = study_id)) +#, shape = timepoint_category
  geom_point(size = 3, alpha = 0.5) +
  labs(
    x = paste0("PCoA1 (", round(pcoa_res$values$Relative_eig[1] * 100, 1), "%)"),
    y = paste0("PCoA2 (", round(pcoa_res$values$Relative_eig[2] * 100, 1), "%)"),
    title = "PCoA on VFDB presence/absence (Jaccard, samples with genes only)"
  ) +
  theme_minimal() +
  theme(legend.position = "bottom")+
  facet_wrap(~timepoint_category)

# 5. Run PERMANOVA (example: Cohort + timepoint_category as predictors)
set.seed(123)  # for reproducibility
permanova_study <- adonis2(vfdb_dist ~ study_id, data = pcoa_df)
permanova_tp <- adonis2(vfdb_dist ~ timepoint_category, data = pcoa_df)
permanova_ic <- adonis2(vfdb_dist ~ study_id+timepoint_category, data = pcoa_df, by="margin")
permanova_inter <- adonis2(
  vfdb_dist ~ study_id * timepoint_category,
  data = pcoa_df,
  by = "terms"
)

# 6. Inspect results
print(permanova_study)
print(permanova_tp)
print(permanova_ic)
print(permanova_inter)
```
# Heatmap per cohort
```{r}
library(pheatmap)

# ---- 1. Calculate prevalence per cohort ----

prevalence_df <- df_long_md %>%
  group_by(Cohort, GENE) %>%
  summarise(
    prevalence = mean(Presence, na.rm = TRUE) * 100,  # percentage
    .groups = "drop"
  )

# ---- 2. Pivot to wide matrix (Gene x Cohort) ----
prevalence_mat <- prevalence_df %>%
  pivot_wider(names_from = Cohort, values_from = prevalence, values_fill = 0) %>%
  as.data.frame()

# set rownames as gene names
rownames(prevalence_mat) <- prevalence_mat$GENE
prevalence_mat$GENE <- NULL

# ---- 3. Plot heatmap ----

pheatmap(
  prevalence_mat,
  scale = "none",
  cluster_rows = TRUE,
  cluster_cols = TRUE,
  color = colorRampPalette(c("lightgrey", "pink", "darkred"))(25),
  main = "Prevalence of S. aureus Virulence Genes"
)

custom_colors <- colorRampPalette(
  c("#4D4D4D", "#88C9BF","#55998A")
)(25)

pheatmap(
  prevalence_mat,
  scale = "none",
  cluster_rows = TRUE,
  cluster_cols = TRUE,
  color = custom_colors,
  main = "Prevalence of S. aureus Virulence Genes"
)


```

# Heatmap per cohort and timepoint
```{r}
library(pheatmap)

# ---- 1. Calculate prevalence per cohort ----

prevalence_df <- df_long_md %>%
  group_by(Cohort, GENE, timepoint_category) %>%
  summarise(
    prevalence = mean(Presence, na.rm = TRUE) * 100,  # percentage
    .groups = "drop"
  )

# ---- 2. Pivot to wide matrix (Gene x Cohort) ----
prevalence_mat <- prevalence_df %>%
  pivot_wider(names_from = c(Cohort, timepoint_category), values_from = prevalence, values_fill = 0) %>%
  as.data.frame()

# set rownames as gene names
rownames(prevalence_mat) <- prevalence_mat$GENE
prevalence_mat$GENE <- NULL

# ---- 3. Plot heatmap ----

pheatmap(
  prevalence_mat,
  scale = "none",
  cluster_rows = TRUE,
  cluster_cols = TRUE,
  color = colorRampPalette(c("lightgrey", "pink", "darkred"))(25),
  main = "Prevalence of S. aureus Virulence Genes"
)

custom_colors <- colorRampPalette(
  c("#4D4D4D", "#88C9BF","#55998A")
)(25)

pheatmap(
  prevalence_mat,
  scale = "none",
  cluster_rows = TRUE,
  cluster_cols = TRUE,
  color = custom_colors,
  main = "Prevalence of S. aureus Virulence Genes"
)

pheatmap(
  prevalence_mat,
  scale = "none",
  cluster_rows = TRUE,
  cluster_cols = FALSE,
  color = custom_colors,
  main = "Prevalence of S. aureus Virulence Genes"
)

```
# Calculate prevalence for S.aureus positive samples only
```{r}
# Assume your gene presence matrix is long format: 
# columns: Sample, GENE, Presence (0/1), study_id, timepoint_category

aureus_df <- readRDS("S.aureus_only_dataframe.rds")

aureus_df <- aureus_df %>% 
  mutate(s_aureus_pos = case_when(Abundance>0~T, T~F)) %>% 
  distinct(Sample, .keep_all = T)

df_long_md <- df_long_md %>% 
  left_join(md_cat_new %>% select(Sample,ID), by=c("Sample"="ID")) %>%
  rename(ID=Sample) %>% 
  rename(Sample=Sample.y)
  
# First, join the s_aureus_pos info
df_aureus_md <- df_long_md %>%
  left_join(aureus_df %>% select(Sample, s_aureus_pos), by = "Sample")

# Filter to only S. aureus positive samples
df_saureus_pos <- df_aureus_md  %>%
  filter(s_aureus_pos == TRUE)

summary(as_factor(df_saureus_pos$Cohort))

# Calculate gene prevalence among S. aureus-positive samples
gene_prevalence_saureus <- df_saureus_pos %>%
  group_by(Cohort, timepoint_category) %>%
  mutate(n_samples = n_distinct(Sample)) %>%
  group_by(GENE, Cohort, n_samples, timepoint_category) %>%
  summarise(count = sum(Presence), .groups = "drop") %>%
  mutate(prevalence = (count / n_samples*100)) %>%
  mutate(Cohort_short = str_split(Cohort, "_") %>% map_chr(1)) %>% 
  mutate(x_label= paste0(Cohort_short, ", N=", n_samples))


gene_prevalence_saureus$Cohort_short <- factor(gene_prevalence_saureus$Cohort_short, levels=c("PRIMAL","Gibson","Rahman",  "Gasparrini",  "Morrow", "Parnanen"))

table(gene_prevalence_saureus$x_label, gene_prevalence_saureus$timepoint_category)

x_label_levels <- c( "PRIMAL, N=23", 
  "PRIMAL, N=159", 
  "PRIMAL, N=16",
  "Gibson, N=45", 
  "Gibson, N=53", 
  "Gibson, N=7",
  "Rahman, N=22", 
  "Rahman, N=37", 
  "Rahman, N=3",
  "Gasparrini, N=13", 
  "Gasparrini, N=16",
 "Gasparrini, N=19",
  "Morrow, N=1", 
  "Morrow, N=14",
  "Parnanen, N=8"
)

gene_prevalence_saureus$x_label <- factor(gene_prevalence_saureus$x_label, levels = x_label_levels)

gene_prevalence_saureus$timepoint_category <- factor(
  gene_prevalence_saureus$timepoint_category, 
  levels = c("DOL 1-8", "DOL 9-42", "DOL 43-455")
)

# Optional: plot as heatmap
library(ggplot2)
gene_prevalence_saureus %>% 
  ggplot(aes(x = reorder(GENE, -prevalence), y = timepoint_category, fill = prevalence)) +
  geom_tile() +
  scale_fill_gradient(low = "lightgrey", high = "#88C9BF") +
  facet_grid(~Cohort_short, scales = "free_x", space="free") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  coord_flip()

library(purrr)
```


```{r, fig.height=10, fig.width=6}
library(ggtext)
p1 <- gene_prevalence_saureus %>% 
  mutate(Cohort_short = str_split(Cohort, "_") %>% map_chr(1)) %>% 
  ggplot(aes(x = reorder(GENE, -prevalence), y = x_label, fill = prevalence)) +
  geom_tile() +
  scale_fill_gradient(low = "lightgrey", high = "#88C9BF") +
  facet_grid(~timepoint_category, scales = "free_x", space="free") +
  theme_minimal() +
  theme(
    strip.background = element_rect(fill = "#F0F0F0", colour = "black"),
    strip.text = element_text(face = "bold", size = 10.5, color = "black"),
    axis.text.x = element_text(angle = 45, hjust = 1),
    panel.spacing = unit(1, "lines"),
    legend.position = "left"
  ) +
  ylab("") +
  xlab(expression(italic("Staphylococcus")~ "virulence genes"))+
  labs(fill = "Prevalence (%)") +
  coord_flip()
p1

gene_prevalence_saureus %>% 
  mutate(Cohort_short = str_split(Cohort, "_") %>% map_chr(1)) %>% 
  ggplot(aes(x = reorder(GENE, -prevalence), y = x_label, fill = prevalence)) +
  geom_tile() +
  scale_fill_gradient(low = "lightgrey", high = "#88C9BF") +
  facet_grid(~Cohort_short, scales = "free_x", space="free") +
  theme_minimal() +
  theme(
    strip.background = element_rect(fill = "#F0F0F0", colour = "black"),
    strip.text = element_text(face = "bold", size = 14, color = "black"),
    axis.text.x = element_text(angle = 45, hjust = 1),
    panel.spacing = unit(1, "lines"),
    legend.position = "bottom"
  ) +
  ylab("") +
  xlab(expression(italic("S. aureus") ~ "virulence genes in" ~ italic("S. aureus") ~ "positive samples"))+
  labs(fill = "Prevalence (%)") +
  coord_flip()+
  ggtitle(expression(italic("S. aureus")~"virulence genes across cohorts and postnatal age"))

```
## boxplot to show the distribution of prevalence across genes per cohort and timepoint
```{r, fig.height=4.8, fig.width=8}
cohort_colors <-  c("PRIMAL"= "#88C9BF", "Morrow"= "#D9D9D9", "Gibson"= "#BDBDBD", "Rahman" ="#969696","Gasparrini"=  "#636363", "Parnanen"="#4D4D4D") 
gene_prevalence_saureus %>% 
  mutate(Cohort_short = str_split(Cohort, "_") %>% map_chr(1)) %>% 
  ggplot(aes(x = x_label, y = prevalence/100, fill = Cohort_short)) +
  geom_boxplot(outlier.shape = NA, width=0.6)+
  scale_y_continuous(labels = scales::percent_format()) +
  scale_fill_manual(values = cohort_colors)+
  facet_wrap(~timepoint_category, scales = "free_x")+
  theme_minimal()+
  theme(
    strip.background = element_rect(fill = "#F0F0F0", colour = "black"),
    strip.text = element_text(face = "bold", size = 14, color = "black"),
    axis.text.x = element_text(angle = 45, hjust = 1, size = 12), axis.text.y=element_text(size = 12), axis.title.y=element_text(size = 14),
    panel.spacing = unit(1, "lines"),
    legend.position = "none"
  )+
  labs(x="", y=expression(italic("Staphylococcus")~ "virulence genes prevalence"))
ggsave("boxplot_gene_prevalence.pdf", height = 4.8, width = 8)
```

```{r}
p3 <- gene_prevalence_saureus %>% 
  group_by(Cohort_short, x_label, timepoint_category) %>% 
  summarise(Median = median(prevalence, na.rm = TRUE), .groups = "drop") %>% 
  ggplot(aes(x = timepoint_category, y = Median, color = Cohort_short, group = Cohort_short)) +
  geom_point(size = 3) +
  geom_line(size = 1) +
  theme_minimal() +
  labs(x = "Postnatal age", y = "Median prevalence (%)", title = "Gene prevalence trajectories", color= "Cohort") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  scale_color_manual(values = cohort_colors)
p3

```


```{r}
# Make a matrix: rows = GENE, columns = Cohort + Timepoint
heatmap_df <- gene_prevalence_saureus %>%
  unite("Cohort_Time", Cohort, timepoint_category, sep = "_") %>%  # combine Cohort and Timepoint
  select(GENE, Cohort_Time, prevalence) %>%
  pivot_wider(names_from = Cohort_Time, values_from = prevalence, values_fill = 0)  # fill NAs with 0

# Convert to matrix and set rownames
heatmap_mat <- as.matrix(heatmap_df[,-1])
rownames(heatmap_mat) <- heatmap_df$GENE

# Plot with pheatmap
pheatmap(
  heatmap_mat,
  color = colorRampPalette(c("lightgrey", "#88C9BF"))(50),
  cluster_rows = TRUE,
  cluster_cols = TRUE,
  border_color = NA,
  angle_col = 45,
  fontsize_row = 8,
  fontsize_col = 10
)

```

# Pangenome heatmap sample resolution
```{r}
df_long_md %>% 
  ggplot(aes(y = GENE, x = Sample, fill = factor(Presence))) +
  geom_tile(color = "white") +
  scale_fill_manual(values = c("0" = "white", "1" = "#88C9BF", "NA"="darkgrey"),
                    name = "Presence") +
  facet_grid(~Cohort, scales = "free_y", space = "free") +
  theme_minimal() +
  theme(
    axis.text.x = element_blank(),
    #axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    panel.spacing = unit(0.5, "lines"),
    strip.background = element_rect(fill = "#F0F0F0", colour = "black")
  ) +
  xlab("Samples") +
  ylab(expression(italic("S. aureus") ~ "virulence genes"))

heatmap_df_sample <- df_long_md %>%
  select(GENE, Sample, Presence) %>%
  pivot_wider(names_from = Sample, values_from = Presence)  # fill NAs with 0 

# Convert to matrix and set rownames
heatmap_mat <- as.matrix(heatmap_df_sample[,-1])
rownames(heatmap_mat) <- heatmap_df_sample$GENE
heatmap_df_sample <- as.data.frame(heatmap_mat)
heatmap_df_sample_filtered <- heatmap_df_sample %>%
  select(where(~ sum(.x, na.rm = TRUE) > 0))

heatmap_fil <- as.matrix(heatmap_df_sample_filtered )
# Plot with pheatmap
pheatmap(
  heatmap_fil,
  color = colorRampPalette(c("lightgrey", "#88C9BF"))(2),
  cluster_rows = TRUE,
  cluster_cols = TRUE,
  border_color = NA,
  angle_col = 45,
  fontsize_row = 8,
  show_colnames = FALSE,
  fontsize_col = 10
)
```

```{r}
library(pheatmap)

# Assume you have a metadata dataframe with Sample and Cohort columns
metadata_df <- df_long_md %>%
  left_join(aureus_df %>% select(Sample, s_aureus_pos), by="Sample") %>% 
   mutate(Cohort_short = str_split(Cohort, "_") %>% map_chr(1)) %>% 
  distinct(Sample, Cohort_short, s_aureus_pos, timepoint_category) %>%
  column_to_rownames(var = "Sample")  # rownames must match column names in heatmap

# Make sure metadata rownames match heatmap column names
metadata_df <- metadata_df[colnames(heatmap_fil), , drop = FALSE]

metadata_df$s_aureus_pos <- ifelse(metadata_df$s_aureus_pos, "TRUE", "FALSE")
# Define a color palette for cohorts
cohort_colors <-  c("PRIMAL"= "#88C9BF", "Morrow"= "#D9D9D9", "Gibson"= "#BDBDBD", "Rahman" ="#969696","Gasparrini"=  "#636363", "Parnanen"="#4D4D4D")  # add as needed
annotation_colors <- list(Cohort_short = cohort_colors, s_aureus_pos = c("TRUE" = "pink", "FALSE" = "black") )

# Plot with pheatmap and cohort annotation
pheatmap(
  heatmap_fil,
  color = colorRampPalette(c("lightgrey", "#55998A"))(2),
  cluster_rows = TRUE,
  cluster_cols = TRUE,
  border_color = NA,
  angle_col = 45,
  fontsize_row = 8,
  fontsize_col = 10,
  show_colnames = FALSE,
  annotation_col = metadata_df,
  annotation_colors = annotation_colors
)

```

```{r, fig.height=12, fig.width=14}
heatmap_df_sample_aureus <- heatmap_df_sample_filtered %>%
  select(all_of(intersect(colnames(.), df_saureus_pos$Sample)))

heatmap_fil_aureus <- as.matrix(heatmap_df_sample_aureus)

# Make sure metadata rownames match heatmap column names
metadata_df <- metadata_df[colnames(heatmap_fil_aureus), , drop = FALSE]

metadata_df <- metadata_df %>% 
  rename(`Postnatal age`=timepoint_category) %>% 
  rename(Cohort = Cohort_short)

metadata_df$s_aureus_pos <- NULL

# Define a color palette for cohorts
cohort_colors <-  c("PRIMAL"= "#88C9BF", "Morrow"= "#D9D9D9", "Gibson"= "#BDBDBD", "Rahman" ="#969696","Gasparrini"=  "#636363", "Parnanen"="#4D4D4D")  # add as needed
annotation_colors <- list(Cohort = cohort_colors, `Postnatal age`= c("DOL 1-8" = "lightblue", "DOL 9-42" = "darkblue",  "DOL 43-455" = "purple" ) )



# Plot with pheatmap and cohort annotation
pheatmap(
  heatmap_fil_aureus,
  color = colorRampPalette(c("lightgrey", "#55998A"))(2),
  cluster_rows = TRUE,
  cluster_cols = TRUE,
  border_color = NA,
  angle_col = 45,
  fontsize_row = 8,
  fontsize_col = 6,
  show_colnames = FALSE,
  annotation_col = metadata_df,
  annotation_colors = annotation_colors
)

# add row colors for Gene Category

# number of unique VF categories
n_cat <- length(unique(vfdb$Category))

library(RColorBrewer)

# make sure palette is long enough
vfdb_palette <- colorRampPalette(brewer.pal(12, "Set3"))(n_cat)

# build row annotation
row_anno <- vfdb %>%
  select(GENE, Category) %>%
  distinct() %>%                # in case GENE repeats
  column_to_rownames("GENE") %>% 
  rename(`Gene category`=Category)

# color mapping for row categories
row_colors <- list(`Gene category` = setNames(vfdb_palette, unique(vfdb$Category)))

# combine with your column annotations
all_colors <- c(annotation_colors, row_colors)


hm <- pheatmap(
  heatmap_fil_aureus,
  color = c("lightgrey", "#55998A"),   # directly specify binary colors
  breaks = c(-0.5, 0.5, 1.5),          # map 0 → first color, 1 → second color
  cluster_rows = TRUE,
  cluster_cols = TRUE,
  border_color = NA,
  angle_col = 45,
  fontsize_row = 12,
  fontsize_col = 12,
  show_colnames = FALSE,
  annotation_col = metadata_df,
  annotation_row = row_anno,
  annotation_colors = all_colors,
  legend_breaks = c(0, 1),             # show only 0 and 1 in legend
  legend_labels = c("Absent", "Present")
)
hm
saveRDS(hm, "heatmap_absence_presence_s_aureus_pos_samples.rds")
# Save to PDF
pdf("heatmap_absence_presence_s_aureus_pos_samples.pdf", height = 12, width = 14)
grid::grid.draw(hm$gtable)  # draw the heatmap grob
dev.off()

```


# PERMANOVA for S. aureus positive samples only
```{r, fig.height=4, fig.width=8}
# 1. Transpose so samples are rows
vfdb_mat_aureus <-  vfdb_mat %>% 
  select(all_of(intersect(colnames(.), df_saureus_pos$ID)))
vfdb_mat_clean_aureus <- vfdb_mat_aureus[ rowSums(vfdb_mat_aureus, na.rm = TRUE) > 0, ]#Remove all-zero genes (rows)
vfdb_mat_t_a <- t(vfdb_mat_clean_aureus )

# 2. Keep only samples with at least one gene
nonzero_samples <- rowSums(vfdb_mat_t_a) > 0
vfdb_mat_nonzero_a <- vfdb_mat_t_a[nonzero_samples, ]

# 3. Compute Jaccard distance
vfdb_dist_a <- vegdist(vfdb_mat_nonzero_a, method = "jaccard", binary = TRUE)

# 4. Run PCoA
pcoa_res <- pcoa(vfdb_dist_a)

# 5. Prepare plotting dataframe
pcoa_df <- as.data.frame(pcoa_res$vectors[, 1:2])
pcoa_df$Sample <- rownames(pcoa_df)

# add metadata
pcoa_df <- pcoa_df %>% 
  left_join(md_cat_new, by = c("Sample"= "ID"))

# 6. Plot
ggplot(pcoa_df, aes(x = Axis.1, y = Axis.2, color = study_id)) +#, shape = timepoint_category
  geom_point(size = 3, alpha = 0.5) +
  labs(
    x = paste0("PCoA1 (", round(pcoa_res$values$Relative_eig[1] * 100, 1), "%)"),
    y = paste0("PCoA2 (", round(pcoa_res$values$Relative_eig[2] * 100, 1), "%)"),
    title = "S. aureus pos PCoA on VFDB presence/absence (Jaccard, samples with genes only)"
  ) +
  theme_minimal() +
  theme(legend.position = "bottom")+
  facet_wrap(~timepoint_category)

# 5. Run PERMANOVA (example: Cohort + timepoint_category as predictors)
set.seed(123)  # for reproducibility
permanova_study <- adonis2(vfdb_dist_a ~ study_id, data = pcoa_df)
permanova_tp <- adonis2(vfdb_dist_a ~ timepoint_category, data = pcoa_df)
permanova_ic <- adonis2(vfdb_dist_a ~ study_id+timepoint_category, data = pcoa_df, by="margin")
permanova_inter <- adonis2(
  vfdb_dist_a ~ study_id * timepoint_category,
  data = pcoa_df,
  by = "terms"
)

# 6. Inspect results
print(permanova_study)
print(permanova_tp)
print(permanova_ic)
print(permanova_inter)
```

# Test difference in Gene category prevalence across cohorts
```{r}
# make prevalence matrix: samples x categories
cat_mat <- df_long_md %>%
  left_join(vfdb %>% select(GENE, Category), by="GENE") %>% 
  group_by(Sample, Category) %>%
  summarise(present = as.integer(any(Presence == 1)), .groups = "drop") %>%
  pivot_wider(names_from = Category, values_from = present, values_fill = 0) %>%
  column_to_rownames("Sample")

category_prev <- df_long_md %>%
  left_join(vfdb %>% select(GENE, Category), by="GENE") %>% 
  group_by(Cohort, Category) %>%
  summarise(prevalence = mean(Presence, na.rm = TRUE), .groups = "drop")

category_prev %>% 
  ggplot(aes(x = reorder(Category, -prevalence), y = prevalence, fill = Cohort)) +
  geom_col(position = "dodge") +
  #coord_flip() +
  scale_y_continuous(labels = scales::percent_format()) +
  labs(x = "Category", y = "Prevalence (fraction of samples with gene)",
       title = "Virulence gene prevalence by cohort") +
  theme_minimal()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "bottom")#+
  facet_wrap(~timepoint_category)
```

## only S. aureus positive samples
```{r}
category_prev_aureus <- df_long_md %>%
  left_join(aureus_df %>% select(Sample, s_aureus_pos), by = "Sample") %>%
  filter(s_aureus_pos == TRUE) %>%
  left_join(vfdb %>% select(GENE, Category), by = "GENE") %>%
  
  # first calculate N per cohort
  group_by(Cohort) %>%
  mutate(n_samples = n_distinct(Sample)) %>%
  ungroup() %>%
  
  # then summarise prevalence per category
  group_by(Cohort, Category, n_samples) %>%
  summarise(prevalence = mean(Presence, na.rm = TRUE), .groups = "drop") %>%
  
  # shorten cohort names + create label
  mutate(
    Cohort_short = str_split(Cohort, "_") %>% map_chr(1),
    x_label = paste0(Cohort_short, ", N=", n_samples)
  )

x_label_levels <- c( "PRIMAL, N=198" , "Gibson, N=105" , "Rahman, N=62" , "Gasparrini, N=48", "Morrow, N=15", "Parnanen, N=8" )

cohort_colors <-  c("PRIMAL, N=198"= "#88C9BF", "Morrow, N=15"= "#D9D9D9", "Gibson, N=105"= "#BDBDBD", "Rahman, N=62" ="#969696","Gasparrini, N=48"=  "#636363", "Parnanen, N=8"="#4D4D4D")

category_prev_aureus$x_label <- factor(category_prev_aureus$x_label, levels = x_label_levels)

summary(as_factor(category_prev_aureus$Category))
ylabel_map <- c(
  "Adherence" = "Adherence",
  "Biofilm" = "Biofilm",
  "Effector delivery system" = "Effector delivery\nsystem",
  "Exoenzyme" = "Exoenzyme",
  "Exotoxin" = "Exotoxin",
  "Immune modulation" = "Immune modulation",
  "Nutritional/Metabolic factor" = "Nutritional/Metabolic\nfactor"
)

 p2 <- category_prev_aureus %>% 
  ggplot(aes(x = reorder(Category, -prevalence), y = prevalence, fill = x_label)) +
  geom_col(position = "dodge") +
  scale_y_continuous(labels = scales::percent_format()) +
  theme_minimal()+
   scale_x_discrete(labels = ylabel_map)+
   scale_fill_manual(values = cohort_colors)+
  theme(text=element_text(size = 16), axis.text.x = element_text(angle = 45, hjust = 1, size=14), axis.text.y = element_text(size=14),legend.position = "none")+
    labs(x = "Virulence gene category", y = expression(italic("Staphylococcus")~" virulence genes prevalence"), fill="Cohort")
 p2
```

## run glm on S.aureus pos. samples and virulence gene categories across samples
```{r}
library(broom)

test_df <- df_long_md %>%
  left_join(aureus_df %>% select(Sample, s_aureus_pos, subject_id), by = "Sample") %>%
  filter(s_aureus_pos == TRUE) %>%
  left_join(vfdb %>% select(GENE, Category), by = "GENE") %>% 
  mutate(Cohort_short = str_split(Cohort, "_") %>% map_chr(1))

test_df$Cohort_short <- factor(test_df$Cohort_short, levels=c("PRIMAL","Gibson","Rahman",  "Gasparrini",  "Morrow", "Parnanen"))

which(is.na(test_df$subject_id)==T)

library(lme4)
library(broom.mixed)  # tidy for mixed models
library(renv)

test_results <-test_df %>%
  group_by(Category) %>%
  do(
    broom.mixed::tidy(
      glmmTMB::glmmTMB(Presence ~ Cohort_short + (1 | subject_id),
                       data = ., family = binomial),
      effects = "fixed",
      conf.int = TRUE,    # get CI directly
      conf.method = "Wald"
    )
  ) %>%
  ungroup() %>%
  mutate(
    OR = exp(estimate),
    OR_low = exp(conf.low),
    OR_high = exp(conf.high),
    fdr = p.adjust(p.value, method = "BH"),
    fdr = round(fdr, digits = 5),
    significance = case_when(
      fdr > 0.05 ~ "ns",
      fdr < 0.001 ~ "***",
      fdr < 0.01 ~ "**",
      fdr < 0.05 ~ "*"
    )
  )

write_csv(test_results, "glmm_results_virulence_gene_categories_across_cohorts.csv")



```

```{r, fig.height=14, fig.width=14}
hm
```


# combine plots
```{r, fig.height=14, fig.width=16}
library(gridExtra)
# Convert to grob
hm_grob <- hm$gtable

grid_arranged <- grid.arrange(
 hm_grob, #+ labs(tag = "a"), #1
  p1 +  labs(tag = "b"), #2
  p2+ labs(tag = "c"), #3
  ncol = 6, nrow = 3,
  heights = c(1.2, 0.8, 0.6),
  widths=c(1.2,1.2,1.4,1.4,1,1),
  layout_matrix = rbind(c(1,1,1,1,2,2),
                        c(1,1,1,1,2,2),
                        c(1,1,1,3,3,3)  )
                       )

#ggsave("/Users/rebecca/Documents/Forschung/IMMProveCF/Manuscript_16S/Nature_Communications/Revision/supp_fig_niche_comparison.pdf",grid_arranged, dpi = 300, width = 16, height = 22)

```
```{r, fig.height=9, fig.width=5.5}
p1
ggsave("prevalence_perDOL_heatmap.pdf", height = 9, width = 6)
```

```{r, fig.height=6.5, fig.width=10}
p2
ggsave("virulence_gene_categories.pdf", height = 6.5, width = 10)
```

```{r, fig.height=3, fig.width=4.5}
p3
ggsave("prevalence_trajectories.pdf", height = 3, width = 4.5)
```
