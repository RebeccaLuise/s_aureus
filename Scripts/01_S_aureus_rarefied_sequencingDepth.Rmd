---
title: "Rarefaction of S.aureus counts"
author: "Rebecca L. Knoll"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
ps_aureus <- readRDS("~/Documents/Forschung/S_aureus_letter/r_analysis_s_aureus/s_aureus/Data/S.aureus_only_phyloseq_20251211.rds")

ps <- readRDS("~/Documents/Forschung/S_aureus_letter/r_analysis_s_aureus/s_aureus/mOTU_catalogue_totalReadcount_20251211.rds")

df_std <- read_delim("~/Documents/Forschung/S_aureus_letter/r_analysis_s_aureus/s_aureus/Data/s_aureus_adjusted_sequencing_depth_20251211.csv")

df_std %>% 
  count(present_median)
```

```{r}
library(phyloseq)
library(dplyr)
library(tidyr)
library(ggplot2)
library(ggpubr)
```

```{r}
sample_sums(ps) %>% summary()
?sample_sums()
otu_table(ps)
colSums(otu_table(ps))%>% summary()
hist(colSums(otu_table(ps)), breaks = 1000)
```

# Rarefaction at Q1 sequencing depth
```{r}
# Step 1: pick rarefaction depth (e.g., 10k or min depth where >90% samples survive)
raref_depth <- 1293

# Step 2: rarefy multiple times
set.seed(123)
n_iter <- 100
rarefied_list <- replicate(n_iter, rarefy_even_depth(ps, sample.size = raref_depth, verbose = FALSE), simplify = FALSE)

# Step 3: extract prevalence of S. aureus in each iteration
get_prevalence <- function(ps_obj) {
  otu <- otu_table(ps_obj)
  # assuming S. aureus is a row, adjust to your naming
  sa_present <- otu[grepl("aureus", tax_table(ps_obj)[, "mOTU"], ignore.case = TRUE)] > 0
  mean(sa_present)  # prevalence as fraction
}

prevalences <- sapply(rarefied_list, get_prevalence)

# Step 4: summarize prevalence across iterations
prev_summary <- data.frame(
  median = median(prevalences),
  q25 = quantile(prevalences, 0.25),
  q75 = quantile(prevalences, 0.75),
  min = min(prevalences),
  max = max(prevalences)
)

# Step 5: plot barplot with error bars
ggplot(prev_summary, aes(x = "S. aureus", y = median)) +
  geom_col(fill = "steelblue") +
  geom_errorbar(aes(ymin = min, ymax = max), width = 0.2) +
  geom_errorbar(aes(ymin = q25, ymax = q75), width = 0.4, color = "darkblue") +
  ylab("Prevalence") +
  xlab("") +
  theme_minimal()
```

```{r}


# Suppose your phyloseq object is ps, with sample_data containing Study and age_days

# Step 1: pick a rarefaction depth
raref_depth <- 1293 # adjust based on sequencing depth distribution
n_iter <- 100         # number of rarefaction replicates

# Step 2: rarefy multiple times
set.seed(123)
rarefied_list <- replicate(
  n_iter,
  rarefy_even_depth(ps, sample.size = raref_depth, verbose = FALSE, replace = FALSE),
  simplify = FALSE
)

# Step 3: function to compute prevalence per Study x age_days
get_prev_summary <- function(ps_obj) {
  # Extract metadata
  meta <- as.data.frame(sample_data(ps_obj))
  
  # Extract S. aureus counts
  # Find all taxa with "aureus" in the mOTU column
aureus_taxa <- taxa_names(ps_obj)[
  grepl("aureus", tax_table(ps_obj)[, "mOTU"], ignore.case = TRUE)
]

# Safety check: stop if none found
if (length(aureus_taxa) == 0) {
  stop("No taxa containing 'aureus' found in mOTU column.")
}

otu <- otu_table(ps_obj)

# Extract counts for all matching taxa and sum them per sample
if (taxa_are_rows(ps_obj)) {
  sa_counts <- colSums(otu[aureus_taxa, , drop = FALSE])
} else {
  sa_counts <- rowSums(otu[, aureus_taxa, drop = FALSE])
}
  
meta <- as.data.frame(sample_data(ps_obj))

  # Ensure length matches metadata rows
  stopifnot(length(sa_counts) == nrow(meta))
  
  # Add presence/absence to metadata
  meta$sa_present <- as.integer(sa_counts > 0)
  
  meta %>%
    group_by(study_id, DOL_category) %>%
    summarise(prevalence = mean(sa_present), N = n(),  .groups = "drop") 
    
}


# Step 4: collect prevalence estimates across iterations
prev_df <- lapply(seq_along(rarefied_list), function(i) {
  get_prev_summary(rarefied_list[[i]]) %>%
    mutate(iter = i)
}) %>% bind_rows()

write_csv(prev_df, "rarefied_1q_seq_depth_prevalence_20251211.csv")

# Step 5: summarise per Study x age_days across iterations
prev_summary <- prev_df %>%
  group_by(study_id, DOL_category ) %>%
  summarise(N=N,
    median = median(prevalence),
    q25 = quantile(prevalence, 0.25),
    q75 = quantile(prevalence, 0.75),
    min = min(prevalence),
    max = max(prevalence),
    .groups = "drop"
  )

```


```{r}
get_sa_depth_df <- function(ps_obj) {
  otu <- as(otu_table(ps_obj), "matrix")
  tax <- as.data.frame(tax_table(ps_obj))
  
  # find S. aureus
  sa_idx <- grepl("aureus", tax_table(ps_obj)[, "mOTU"], ignore.case = TRUE)
  if (!any(sa_idx)) return(NULL)
  
  sa_present <- colSums(otu[sa_idx, , drop = FALSE]) > 0
  
  meta <- data.frame(sample_data(ps_obj)) %>%
    mutate(
      sa_present = as.integer(sa_present),
      Total_read_count = sample_sums(ps_obj)
    )
  return(meta)
}

raref_depth_df <- map_dfr(seq_along(rarefied_list), function(i) {
  df <- get_sa_depth_df(rarefied_list[[i]])
  if (!is.null(df)) df$iter <- i
  df
})

ggplot(raref_depth_df, aes(x = factor(sa_present), 
                           y = log10(Total_read_count))) +
  geom_boxplot(outlier.shape = NA) +
  #facet_wrap(~ iter, ncol = 10) +   # see across all rarefactions
  stat_compare_means(method = "wilcox") +
  labs(
    title = "S. aureus prevalence vs sequencing depth after rarefaction",
    x = "S. aureus Presence (0/1)",
    y = "log10 Total read count"
  ) +
  theme_minimal()


```

```{r}

raref_depth_df%>%
  filter(is.na(sa_present))

raref_depth_df%>%
  group_by(sample_alias) %>% 
  summarise(sa_present_mean=mean(sa_present)) %>% 
  mutate(sa_present_likely = case_when(sa_present_mean>0.5~T,sa_present_mean<0.5~F)) %>% 
  filter(!is.na(sa_present_likely)) %>% 
  left_join(df_std %>% select(present_actual, present_median, Total_read_count, sample_alias), by="sample_alias") %>% 
  filter(!is.na(present_median)) %>% 
  select(sa_present_likely, present_actual, present_median, Total_read_count) %>% 
  rename("Q1 Rarefaction" = sa_present_likely,
    "Median Depth Adjustment" = present_median,
    "Prior Depth Adjustment" = present_actual
  ) %>% 
  pivot_longer(
    cols = c("Median Depth Adjustment", "Prior Depth Adjustment","Q1 Rarefaction"),
    names_to = "method", 
    values_to = "Presence"
  ) %>% 
  mutate(
    Presence = as.logical(Presence),
    method = factor(method, levels = c(
      "Prior Depth Adjustment",
      "Median Depth Adjustment","Q1 Rarefaction"
    )) # <-- order defined here
  ) %>% 
  ggplot(aes(x = Presence, y = Total_read_count)) +
  geom_boxplot(outlier.shape = NA, fill = "lightgrey", alpha = 0.8) +
  geom_jitter(alpha=0.2, width = 0.2)+
  stat_compare_means(
    method = "wilcox", 
    label = "p"
  ) +
  scale_y_log10()+
  facet_wrap(~ method, ncol = 3) +
  labs(
    x = "*S.aureus* detected",
    y = "Total read count (log scale)",
    title = "Effect of depth adjustment on *S.aureus* prevalence calls"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    strip.text = element_text(face = "bold", size = 12),
    axis.text.x = element_text(angle = 45, hjust = 1),
    title = element_markdown(),axis.title.x = element_markdown()
    
  )
```

```{r, fig.height=6, fig.width=8}
library(dplyr)
library(ggplot2)

plot_df <- raref_depth_df %>%
  group_by(sample_alias) %>% 
  summarise(sa_present_mean = mean(sa_present)) %>% 
  mutate(sa_present_likely = case_when(
    sa_present_mean > 0.5 ~ TRUE,
    sa_present_mean < 0.5 ~ FALSE
  )) %>% 
  filter(!is.na(sa_present_likely)) %>% 
  left_join(df_std %>% 
              select(present_actual, present_median, Total_read_count, sample_alias), 
            by = "sample_alias") %>% 
  filter(!is.na(present_median)) %>% 
  select(sa_present_likely, present_actual, present_median, Total_read_count) %>% 
  rename(
    "Q1 Rarefaction" = sa_present_likely,
    "Median Depth Adjustment" = present_median,
    "Prior Depth Adjustment" = present_actual
  ) %>% 
  pivot_longer(
    cols = c("Median Depth Adjustment", "Prior Depth Adjustment","Q1 Rarefaction"),
    names_to = "method", 
    values_to = "Presence"
  ) %>% 
  mutate(
    Presence = as.logical(Presence),
    method = factor(method, levels = c(
      "Prior Depth Adjustment",
      "Median Depth Adjustment","Q1 Rarefaction"
    ))
  )

# calculate N’s per facet + presence
n_counts <- plot_df %>%
  group_by(method, Presence) %>%
  summarise(N = n(), .groups = "drop") %>%
  mutate(label = paste0(Presence, "\n(N=", N, ")"))

ggplot(plot_df, aes(x = Presence, y = Total_read_count)) +
  geom_boxplot(outlier.shape = NA, fill = "lightgrey", alpha = 0.8) +
  geom_jitter(alpha = 0.2, width = 0.2) +
  stat_compare_means(method = "wilcox", label = "p") +
  stat_summary(fun = "median", geom = "point", shape = 23, size = 2, fill = "red") +
  geom_text(
    data = n_counts,
    aes(x = Presence, y = min(plot_df$Total_read_count)* 0.9 , label = paste0("N=", N)),
    inherit.aes = FALSE
  ) +
  scale_y_log10() +
  facet_wrap(~ method, ncol = 3)+
  theme_minimal(base_size = 14) +
  theme(
    strip.text = element_text(face = "bold", size = 12),
    axis.text.x = element_text(angle = 45, hjust = 1),
    title = element_markdown(),axis.title.x = element_markdown()
     )+
  labs(
    x = "*S.aureus* detected",
    y = "Total read count (log scale)"
    #title = "Effect of depth adjustment on *S.aureus* prevalence calls"
  )

ggsave("seq_depth_normalization_comparison_20251211.pdf", height = 6, width = 8)

```


# plot
```{r}
# Step 6: plot
ggplot(prev_summary, aes(x = DOL_category, y = median, fill = study_id)) +
  geom_col(position = position_dodge(width = 0.8)) +
  geom_errorbar(
    aes(ymin = q25, ymax = q75),
    width = 0.3,
    position = position_dodge(width = 0.8),
    color = "black"
  ) +
  geom_errorbar(
    aes(ymin = min, ymax = max),
    width = 0.1,
    position = position_dodge(width = 0.8),
    color = "grey50"
  ) +
  ylab("Prevalence of S. aureus") +
  theme_minimal()

```
```{r}
# --- Define the fixed order (must match your palette keys) ---
study_order <- c("PRIMAL","Gibson","Rahman","Gasparrini","Morrow","Pärnanen")
time_levels <- c("DOL 1-8","DOL 9-42","DOL 43-455")

# Define short names (keys = long names, values = short labels)
short_map <- c(
  "PRIMAL"      = "PRIMAL",
   "Gibson_2016_preterm"="Gibson",
  "Rahman_2018_preterm_NICU"="Rahman",
  "Gasparrini_2019_infant"="Gasparrini",
  "Morrow_2016_preterm_infants"="Morrow",
  "Parnanen_2019_infant"="Pärnanen" 
)

prev_by_study_tp <- prev_summary %>%
  mutate(
    study_short = ifelse(study_id %in% names(short_map),
                         short_map[as.character(study_id)],
                         as.character(study_id)),
    age_days = factor(DOL_category, levels = time_levels),
    study_short = factor(study_short, levels = study_order),
    x_label = paste0(as.character(study_short), ", N=", N),
    x_key   = paste(age_days, x_label, sep = "|")
  ) %>%
  group_by(age_days) %>%
  arrange(study_short, .by_group = TRUE) %>%
  ungroup()

levels_prev <- prev_by_study_tp %>%
  arrange(age_days, study_short) %>%
  pull(x_key) %>% unique()

prev_by_study_tp <- prev_by_study_tp %>%
  mutate(x_key = factor(x_key, levels = levels_prev))

fill_palette <- c(
  "PRIMAL"     = "#88C9BF",
  "Gibson"     = "#D9D9D9",
  "Rahman"     = "#BDBDBD",
  "Gasparrini" = "#969696",
  "Morrow"     = "#636363",
  "Pärnanen"   = "#4D4D4D"
)
present <- union(unique(as.character(prev_by_study_tp$study_short)),
                 unique(as.character(df_std$study_short)))
legend_order <- study_order[study_order %in% present]
fill_palette <- fill_palette[legend_order]

prev_by_study_tp %>% 
ggplot(aes(x = x_key, y = median, fill = study_short)) +
  geom_col() +
  geom_errorbar(
    aes(ymin = q25*100, ymax = q75*100),
    width = 0.3,
    position = position_dodge(width = 0.8),
    color = "black"
  ) +
  geom_errorbar(
    aes(ymin = min*100, ymax = max*100),
    width = 0.1,
    position = position_dodge(width = 0.8),
    color = "grey50"
  )+
  #scale_y_continuous(labels = scales::percent_format()) +
  scale_fill_manual(values = fill_palette, breaks = legend_order, drop = FALSE) +
  facet_grid(~ age_days, scales = "free_x", space = "free") +
  scale_x_discrete(labels = function(x) sub("^[^|]*\\|", "", x)) +
  labs(
    title = "Rarefied *S. aureus* prevalence ",
    subtitle = paste0("Rarefied to 1st IQR = ", format(raref_depth, big.mark=","), " taxonomic reads, 100x replicated"),
    y = "*S. aureus* prevalence (%)", x = "", fill = "Study"
  ) +
  theme_minimal(base_size = 14) +
  theme(strip.background = element_rect(fill = "#F0F0F0", colour = "black"),
        strip.text = element_text(face = "bold", size = 14),
        axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title.y = ggtext::element_markdown(),
        title = ggtext::element_markdown(),
        panel.spacing = unit(1, "lines")) +
  guides(fill = guide_legend(nrow = 1, position = "bottom"))

ggsave("rarefied_S_aureus_prevalence_20251211.pdf", width = 8, height = 5)
```

#repeat rarefaction at median seq depth
```{r}
# Step 1: pick a rarefaction depth
summary(df$tax_reads)
raref_depth <- 6234 # median sequencing depth distribution
n_iter <- 100         # number of rarefaction replicates

# Step 2: rarefy multiple times
set.seed(123)
rarefied_list <- replicate(
  n_iter,
  rarefy_even_depth(ps, sample.size = raref_depth, verbose = FALSE, replace = FALSE),
  simplify = FALSE
)

# Step 3: function to compute prevalence per Study x age_days
get_prev_summary <- function(ps_obj) {
  # Extract metadata
  meta <- as.data.frame(sample_data(ps_obj))
  
  # Extract S. aureus counts
  # Find all taxa with "aureus" in the mOTU column
aureus_taxa <- taxa_names(ps_obj)[
  grepl("aureus", tax_table(ps_obj)[, "mOTU"], ignore.case = TRUE)
]

# Safety check: stop if none found
if (length(aureus_taxa) == 0) {
  stop("No taxa containing 'aureus' found in mOTU column.")
}

otu <- otu_table(ps_obj)

# Extract counts for all matching taxa and sum them per sample
if (taxa_are_rows(ps_obj)) {
  sa_counts <- colSums(otu[aureus_taxa, , drop = FALSE])
} else {
  sa_counts <- rowSums(otu[, aureus_taxa, drop = FALSE])
}
  
meta <- as.data.frame(sample_data(ps_obj))

  # Ensure length matches metadata rows
  stopifnot(length(sa_counts) == nrow(meta))
  
  # Add presence/absence to metadata
  meta$sa_present <- as.integer(sa_counts > 0)
  
  meta %>%
    group_by(study_id, DOL_category) %>%
    summarise(prevalence = mean(sa_present), N = n(),  .groups = "drop") 
    
}

# Step 4: collect prevalence estimates across iterations
prev_df <- lapply(seq_along(rarefied_list), function(i) {
  get_prev_summary(rarefied_list[[i]]) %>%
    mutate(iter = i)
}) %>% bind_rows()

write_csv(prev_df, "rarefied_median_seq_depth_prevalence_20251211.csv")

# Step 5: summarise per Study x age_days across iterations
prev_summary <- prev_df %>%
  group_by(study_id, DOL_category ) %>%
  summarise(N=N,
    median = median(prevalence),
    q25 = quantile(prevalence, 0.25),
    q75 = quantile(prevalence, 0.75),
    min = min(prevalence),
    max = max(prevalence),
    .groups = "drop"
  )

prev_df %>% 
group_by(DOL_category) %>%
  summarise(prevalence_median = median(prevalence, na.rm = TRUE)*100, .groups = "drop")

prev_df %>% 
group_by(age_days) %>%
  count()

summary(as_factor(sample_data(rarefied_list[[1]])$DOL_category))
summary(as_factor(sample_data(rarefied_list[[1]])$study_id))
table(
  sample_data(rarefied_list[[1]])$DOL_category,
  sample_data(rarefied_list[[1]])$study_id
)
```

