---
title: "Rarefaction of S.aureus counts"
author: "Rebecca L. Knoll"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
ps <- readRDS("~/Documents/Forschung/S_aureus_letter/r_analysis_s_aureus/s_aureus/Scripts/vfdb_phyloseq.rds")

```

```{r}
library(phyloseq)
library(dplyr)
library(tidyr)
library(ggplot2)
```

```{r}
sample_sums(ps) %>% summary()
?sample_sums()
otu_table(ps)
colSums(otu_table(ps))%>% summary()
hist(colSums(otu_table(ps)), breaks = 100)
```


```{r}
# Step 1: pick rarefaction depth (e.g., 10k or min depth where >90% samples survive)
raref_depth <- 1284

# Step 2: rarefy multiple times
set.seed(123)
n_iter <- 100
rarefied_list <- replicate(n_iter, rarefy_even_depth(ps, sample.size = raref_depth, verbose = FALSE), simplify = FALSE)

# Step 3: extract prevalence of S. aureus in each iteration
get_prevalence <- function(ps_obj) {
  otu <- otu_table(ps_obj)
  # assuming S. aureus is a row, adjust to your naming
  sa_present <- otu[grepl("aureus", tax_table(ps_obj)[, "mOTU"], ignore.case = TRUE)] > 0
  mean(sa_present)  # prevalence as fraction
}

prevalences <- sapply(rarefied_list, get_prevalence)

# Step 4: summarize prevalence across iterations
prev_summary <- data.frame(
  median = median(prevalences),
  q25 = quantile(prevalences, 0.25),
  q75 = quantile(prevalences, 0.75),
  min = min(prevalences),
  max = max(prevalences)
)

# Step 5: plot barplot with error bars
ggplot(prev_summary, aes(x = "S. aureus", y = median)) +
  geom_col(fill = "steelblue") +
  geom_errorbar(aes(ymin = min, ymax = max), width = 0.2) +
  geom_errorbar(aes(ymin = q25, ymax = q75), width = 0.4, color = "darkblue") +
  ylab("Prevalence") +
  xlab("") +
  theme_minimal()
```


```{r}
library(phyloseq)
library(dplyr)
library(tidyr)
library(ggplot2)

# Suppose your phyloseq object is ps, with sample_data containing Study and Timepoint

# Step 1: pick a rarefaction depth
raref_depth <- 1284 # adjust based on sequencing depth distribution
n_iter <- 100         # number of rarefaction replicates

# Step 2: rarefy multiple times
set.seed(123)
rarefied_list <- replicate(
  n_iter,
  rarefy_even_depth(ps, sample.size = raref_depth, verbose = FALSE, replace = FALSE),
  simplify = FALSE
)

# Step 3: function to compute prevalence per Study x Timepoint
get_prev_summary <- function(ps_obj) {
  # Extract metadata
  meta <- as.data.frame(sample_data(ps_obj))
  
  # Extract S. aureus counts
  # Find all taxa with "aureus" in the mOTU column
aureus_taxa <- taxa_names(ps_obj)[
  grepl("aureus", tax_table(ps_obj)[, "mOTU"], ignore.case = TRUE)
]

# Safety check: stop if none found
if (length(aureus_taxa) == 0) {
  stop("No taxa containing 'aureus' found in mOTU column.")
}

otu <- otu_table(ps_obj)

# Extract counts for all matching taxa and sum them per sample
if (taxa_are_rows(ps_obj)) {
  sa_counts <- colSums(otu[aureus_taxa, , drop = FALSE])
} else {
  sa_counts <- rowSums(otu[, aureus_taxa, drop = FALSE])
}
  
meta <- as.data.frame(sample_data(ps_obj))

  # Ensure length matches metadata rows
  stopifnot(length(sa_counts) == nrow(meta))
  
  # Add presence/absence to metadata
  meta$sa_present <- as.integer(sa_counts > 0)
  
  meta %>%
    group_by(study_id, timepoint_category) %>%
    summarise(prevalence = mean(sa_present), N = n(),  .groups = "drop") 
    
}



# Step 4: collect prevalence estimates across iterations
prev_df <- lapply(seq_along(rarefied_list), function(i) {
  get_prev_summary(rarefied_list[[i]]) %>%
    mutate(iter = i)
}) %>% bind_rows()

#write_csv(prev_df, "rarefied_median_seq_depth_prevalence.csv")

# Step 5: summarise per Study x Timepoint across iterations
prev_summary <- prev_df %>%
  group_by(study_id, timepoint_category) %>%
  summarise(N=N,
    median = median(prevalence),
    q25 = quantile(prevalence, 0.25),
    q75 = quantile(prevalence, 0.75),
    min = min(prevalence),
    max = max(prevalence),
    .groups = "drop"
  )
```

# plot
```{r}
# Step 6: plot
ggplot(prev_summary, aes(x = timepoint_category, y = median, fill = study_id)) +
  geom_col(position = position_dodge(width = 0.8)) +
  geom_errorbar(
    aes(ymin = q25, ymax = q75),
    width = 0.3,
    position = position_dodge(width = 0.8),
    color = "black"
  ) +
  geom_errorbar(
    aes(ymin = min, ymax = max),
    width = 0.1,
    position = position_dodge(width = 0.8),
    color = "grey50"
  ) +
  ylab("Prevalence of S. aureus") +
  theme_minimal()

```
```{r}
# --- Define the fixed order (must match your palette keys) ---
study_order <- c("PRIMAL","Gibson","Rahman","Gasparrini","Morrow","Pärnanen")
time_levels <- c("DOL 1-8","DOL 9-42","DOL 43-455")

# Define short names (keys = long names, values = short labels)
short_map <- c(
  "PRIMAL"      = "PRIMAL",
   "Gibson_2016_preterm"="Gibson",
  "Rahman_2018_preterm_NICU"="Rahman",
  "Gasparrini_2019_infant"="Gasparrini",
  "Morrow_2016_preterm_infants"="Morrow",
  "Parnanen_2019_infant"="Pärnanen" 
)

prev_by_study_tp <- prev_summary %>%
  mutate(
    study_short = ifelse(study_id %in% names(short_map),
                         short_map[as.character(study_id)],
                         as.character(study_id)),
    Timepoint = factor(timepoint_category, levels = time_levels),
    study_short = factor(study_short, levels = study_order),
    x_label = paste0(as.character(study_short), ", N=", N),
    x_key   = paste(Timepoint, x_label, sep = "|")
  ) %>%
  group_by(Timepoint) %>%
  arrange(study_short, .by_group = TRUE) %>%
  ungroup()

levels_prev <- prev_by_study_tp %>%
  arrange(Timepoint, study_short) %>%
  pull(x_key) %>% unique()

prev_by_study_tp <- prev_by_study_tp %>%
  mutate(x_key = factor(x_key, levels = levels_prev))

fill_palette <- c(
  "PRIMAL"     = "#88C9BF",
  "Gibson"     = "#D9D9D9",
  "Rahman"     = "#BDBDBD",
  "Gasparrini" = "#969696",
  "Morrow"     = "#636363",
  "Pärnanen"   = "#4D4D4D"
)
present <- union(unique(as.character(prev_by_study_tp$study_short)),
                 unique(as.character(df_for_plot$study_short)))
legend_order <- study_order[study_order %in% present]
fill_palette <- fill_palette[legend_order]

prev_by_study_tp %>% 
ggplot(aes(x = x_key, y = median, fill = study_short)) +
  geom_col() +
  geom_errorbar(
    aes(ymin = q25*100, ymax = q75*100),
    width = 0.3,
    position = position_dodge(width = 0.8),
    color = "black"
  ) +
  geom_errorbar(
    aes(ymin = min*100, ymax = max*100),
    width = 0.1,
    position = position_dodge(width = 0.8),
    color = "grey50"
  )+
  #scale_y_continuous(labels = scales::percent_format()) +
  scale_fill_manual(values = fill_palette, breaks = legend_order, drop = FALSE) +
  facet_grid(~ Timepoint, scales = "free_x", space = "free") +
  scale_x_discrete(labels = function(x) sub("^[^|]*\\|", "", x)) +
  labs(
    title = "Rarefied *S. aureus* prevalence ",
    subtitle = paste0("Rarefied to 1st IQR = ", format(raref_depth, big.mark=","), " taxonomic reads, 100x replicated"),
    y = "*S. aureus* prevalence (%)", x = "", fill = "Study"
  ) +
  theme_minimal(base_size = 14) +
  theme(strip.background = element_rect(fill = "#F0F0F0", colour = "black"),
        strip.text = element_text(face = "bold", size = 14),
        axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title.y = ggtext::element_markdown(),
        title = ggtext::element_markdown(),
        panel.spacing = unit(1, "lines")) +
  guides(fill = guide_legend(nrow = 1, position = "bottom"))

ggsave("rarefied_S_aureus_prevalence.pdf", width = 8, height = 5)
```

